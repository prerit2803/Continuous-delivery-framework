---
- name: Install python-pip
  become: yes
  apt:
    name: python-pip
    state: latest

- name: Install Jenkins Job Builder
  become: yes
  pip:
    name: jenkins-job-builder

- name: Disable Jenkins' initial authorization wizard
  become: yes
  replace:
    path: /etc/default/jenkins
    regexp: -Djava.awt.headless=true
    replace: -Djava.awt.headless=true -Djenkins.install.runSetupWizard=false

- name: Copy init.grovy to $Jenkins_home
  become: yes
  copy:
    src: ./jenkins_files/init.groovy
    dest: /var/lib/jenkins/init.groovy

- import_tasks: restart_jenkins.yml

- name: Install plugins for Jenkins
  jenkins_plugin:
    name: "{{item}}"
  with_items:
    - git
    - postbuild-task
    - postbuildscript
    - envinject
  tags:
    installer

- import_tasks: restart_jenkins.yml

- name: Copy jenkins_files directory
  become: yes
  copy:
    src: ./jenkins_files
    dest: "{{ ansible_env.HOME }}"

- name: Upload Itrust Job to Jenkins
  shell: 'jenkins-jobs update itrust.yml'
  args:
    chdir: "{{ ansible_env.HOME }}/jenkins_files"
  tags:
    upload

- name: Upload Checkbox Job to Jenkins
  shell: 'jenkins-jobs update checkbox.yml'
  args:
    chdir: "{{ ansible_env.HOME }}/jenkins_files"
  tags:
    upload

- name: Trigger build for Checkbox
  become: yes
  shell: "java -jar /var/cache/jenkins/war/WEB-INF/jenkins-cli.jar -s http://localhost:8080/ build 'checkbox-build'"
  tags:
    build-jobs

- name: Trigger build for iTrust
  become: yes
  shell: "java -jar /var/cache/jenkins/war/WEB-INF/jenkins-cli.jar -s http://localhost:8080/ build 'itrust-build'"
  tags:
    build-jobs